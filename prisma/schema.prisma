generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(FLOOR_MANAGER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userWarehouses UserWarehouse[]
  auditSessions  AuditSession[]
  floorSessions  FloorSession[]
  auditLogs      AuditLog[]
  exports        ExportFile[]

  @@map("users")
}

enum Role {
  FLOOR_MANAGER
  INVENTORY_MANAGER
  ADMIN
}

// Warehouse Model
model Warehouse {
  id        String   @id @default(cuid())
  name      String   @unique
  location  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userWarehouses UserWarehouse[]
  floors         Floor[]
  auditSessions  AuditSession[]
  auditLogs      AuditLog[]

  @@map("warehouses")
}

// User-Warehouse Assignment
model UserWarehouse {
  id          String   @id @default(cuid())
  userId      String
  warehouseId String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([userId, warehouseId])
  @@map("user_warehouses")
}

// Floor Model (now tied to Warehouse)
model Floor {
  id          String   @id @default(cuid())
  warehouseId String
  name        String // e.g., "Floor 1", "Floor 2"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  warehouse     Warehouse      @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  floorSessions FloorSession[]
  auditLogs     AuditLog[]

  @@unique([warehouseId, name])
  @@map("floors")
}

// Audit Session (per warehouse per date/time)
model AuditSession {
  id          String      @id @default(cuid())
  warehouseId String
  userId      String // Auditor/Authority
  auditDate   DateTime    @db.Date
  auditTime   DateTime?
  status      AuditStatus @default(DRAFT)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  warehouse     Warehouse      @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  floorSessions FloorSession[]
  auditLogs     AuditLog[]
  ExportFile    ExportFile[]

  @@unique([warehouseId, auditDate])
  @@map("audit_sessions")
}

enum AuditStatus {
  DRAFT
  IN_PROGRESS
  SUBMITTED
  APPROVED
}

// Item Category
model ItemCategory {
  id   String @id @default(cuid())
  name String @unique

  // Relations
  subCategories ItemSubCategory[]
  items         Item[]

  @@map("item_categories")
}

// Item Sub-Category
model ItemSubCategory {
  id         String @id @default(cuid())
  categoryId String
  name       String

  // Relations
  category ItemCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  items    Item[]

  @@unique([categoryId, name])
  @@map("item_sub_categories")
}

// Item Master
model Item {
  id            String   @id @default(cuid())
  name          String
  categoryId    String
  subCategoryId String?
  description   String?
  kgPerUnit     Float // Package size in kg
  unitName      String // e.g., "Bag", "Box", "Carton"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  category    ItemCategory     @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  subCategory ItemSubCategory? @relation(fields: [subCategoryId], references: [id], onDelete: SetNull)
  stockLines  StockLine[]

  @@map("items")
}

// Floor Session (per floor per audit)
model FloorSession {
  id          String      @id @default(cuid())
  auditId     String
  floorId     String
  userId      String
  status      FloorStatus @default(DRAFT)
  isVerified  Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  submittedAt DateTime?
  approvedAt  DateTime?
  verifiedAt  DateTime?

  // Relations
  audit   AuditSession @relation(fields: [auditId], references: [id], onDelete: Cascade)
  floor   Floor        @relation(fields: [floorId], references: [id], onDelete: Cascade)
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  pallets Pallet[]
  exports ExportFile[]

  @@unique([auditId, floorId])
  @@map("floor_sessions")
}

enum FloorStatus {
  DRAFT
  SUBMITTED
  APPROVED
}

// Pallet (Internal grouping, temporary, no persistent ID in exports)
model Pallet {
  id             String   @id @default(cuid())
  floorSessionId String
  palletNumber   Int // Auto-numbered within session
  locationNote   String? // e.g., "Near Lift", "Corner A"
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  floorSession FloorSession @relation(fields: [floorSessionId], references: [id], onDelete: Cascade)
  stockLines   StockLine[]

  @@unique([floorSessionId, palletNumber])
  @@map("pallets")
}

// Stock Line Item (items within pallets)
model StockLine {
  id           String   @id @default(cuid())
  palletId     String
  itemId       String
  units        Int // Number of units
  calculatedKg Float // Calculated: units Ã— kgPerUnit
  measuredKg   Float? // Measured weight (optional override)
  remark       String? // Remark when measured KG differs
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  pallet Pallet @relation(fields: [palletId], references: [id], onDelete: Cascade)
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@map("stock_lines")
}

// Audit Log
model AuditLog {
  id          String   @id @default(cuid())
  action      String // create, update, delete, submit, approve, verify, export
  entityType  String // User, Warehouse, Floor, Item, FloorSession, Pallet, StockLine, AuditSession
  entityId    String
  userId      String
  warehouseId String?
  auditId     String?
  beforeData  Json? // JSON snapshot before change
  afterData   Json? // JSON snapshot after change
  timestamp   DateTime @default(now())

  // Relations
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  warehouse Warehouse?    @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  audit     AuditSession? @relation(fields: [auditId], references: [id], onDelete: SetNull)
  Floor     Floor?        @relation(fields: [floorId], references: [id])
  floorId   String?

  @@map("audit_logs")
}

// Export File
model ExportFile {
  id             String   @id @default(cuid())
  floorSessionId String?
  auditId        String?
  fileName       String
  filePath       String?
  generatedBy    String
  generatedAt    DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  floorSession FloorSession? @relation(fields: [floorSessionId], references: [id], onDelete: SetNull)
  audit        AuditSession? @relation(fields: [auditId], references: [id], onDelete: SetNull)
  user         User          @relation(fields: [generatedBy], references: [id], onDelete: Cascade)

  @@map("export_files")
}

// StockTake Entry - Stores individual item entries submitted by floor users
model StockTakeEntry {
  id               Int      @id @default(autoincrement())
  itemName         String   @db.VarChar(255)
  itemType         String   @db.VarChar(10) // 'PM', 'RM', 'FG'
  itemCategory     String   @db.VarChar(255) // Group
  itemSubcategory  String   @db.VarChar(255) // Sub-group
  floorName        String   @db.VarChar(255)
  warehouse        String   @db.VarChar(255)
  totalQuantity    Int // Number of units
  unitUom          Decimal  @db.Decimal(10, 3) // UOM (weight per unit in kg)
  totalWeight      Decimal  @db.Decimal(10, 2) // Calculated: totalQuantity * unitUom
  enteredBy        String   @db.VarChar(255) // Username
  enteredByEmail   String?  @db.VarChar(255) // User email
  authority        String   @db.VarChar(255)
  createdAt        DateTime @default(now()) @db.Timestamp
  updatedAt        DateTime @updatedAt @db.Timestamp

  @@index([itemName])
  @@index([warehouse])
  @@index([floorName])
  @@index([enteredBy])
  @@index([createdAt])
  @@index([itemType])
  @@index([warehouse, floorName])
  @@map("stocktake_entries")
}
